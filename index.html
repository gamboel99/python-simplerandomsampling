<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Simple Random Sampling Unik Global</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    th { background-color: #eee; }
    .center { text-align: center; }
    body { font-family: sans-serif; margin: 20px; }
    input { padding: 5px; margin-right: 10px; width: 120px; }
  </style>
</head>
<body>
  <h2>Simple Random Sampling (Responden Unik Global)</h2>

  <form id="samplingForm" onsubmit="handleGenerate(event)">
    <label>Jumlah Populasi:</label>
    <input type="number" id="populasi" required value="1061" />
    
    <label>Jumlah Sampel:</label>
    <input type="number" id="sampel" required value="109" />
    
    <label>Derajat Keyakinan:</label>
    <input type="text" id="keyakinan" required value="95%" />
    
    <button type="submit">Generate Sampel</button>
  </form>

  <div id="tableContainer" style="margin-top: 20px;"></div>
  <p id="totalInfo"></p>
  <button onclick="downloadExcel()">Unduh Excel</button>

<script>
const dataPuskesmas = [
  ["PRAGAAN", 53], ["BLUTO", 37], ["SARONGGI", 27], ["GILI GENTING", 25], ["TALANGO", 27],
  ["KALIANGET", 34], ["PANDIAN", 23], ["PAMOLOKAN", 26], ["BATUAN", 25], ["LENTENG", 36],
  ["MONCEK TENGAH", 21], ["GANDING", 43], ["GULUK-GULUK", 43], ["PASONGSONGAN", 37],
  ["AMBUNTEN", 48], ["RUBARU", 38], ["DASUK", 27], ["MANDING", 35], ["BATU PUTIH", 28],
  ["GAPURA", 36], ["BATANG BATANG", 40], ["LEGUNG TIMUR", 25], ["DUNGKEK", 27],
  ["NONGGUNONG", 22], ["GAYAM", 31], ["RAAS", 17], ["SAPEKEN", 49], ["ARJASA", 108],
  ["KANGAYAN", 54], ["MASALEMBU", 19]
];

let finalData = [];

function getUniqueRandoms(n, max) {
  const arr = Array.from({ length: max }, (_, i) => i + 1);
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr.slice(0, n).sort((a,b) => a - b);
}

function handleGenerate(event) {
  event.preventDefault();

  const totalPopulasi = parseInt(document.getElementById('populasi').value);
  const totalSampel = parseInt(document.getElementById('sampel').value);
  const keyakinan = document.getElementById('keyakinan').value;

  let table = `<table><tr>
    <th>No</th><th>Nama Puskesmas</th><th>Jumlah Populasi</th>
    <th>Jumlah Sampel</th><th>Responden Global Acak</th></tr>`;
  let rows = [];
  let jumlahSampelFix = [];

  // Alokasi proporsional
  let totalS = 0;
  dataPuskesmas.forEach(([_, pop]) => {
    let sampel = Math.round(pop / totalPopulasi * totalSampel);
    jumlahSampelFix.push(sampel);
    totalS += sampel;
  });

  // Koreksi jumlah total agar tepat 109
  let selisih = totalS - totalSampel;
  while (selisih !== 0) {
    let idx = selisih > 0
      ? jumlahSampelFix.indexOf(Math.max(...jumlahSampelFix))
      : jumlahSampelFix.indexOf(Math.min(...jumlahSampelFix));
    jumlahSampelFix[idx] += selisih > 0 ? -1 : 1;
    selisih += selisih > 0 ? -1 : 1;
  }

  // Ambil 109 angka unik acak dari 1â€“1061
  const globalResponden = getUniqueRandoms(totalSampel, totalPopulasi);
  let pointer = 0;

  dataPuskesmas.forEach(([nama, pop], i) => {
    const s = jumlahSampelFix[i];
    const acak = globalResponden.slice(pointer, pointer + s);
    pointer += s;

    rows.push({
      No: i + 1,
      "Nama Puskesmas": nama,
      "Jumlah Populasi": pop,
      "Jumlah Sampel": s,
      "Responden Global Acak": acak.join(", ")
    });

    table += `<tr>
      <td class="center">${i + 1}</td>
      <td>${nama}</td>
      <td class="center">${pop}</td>
      <td class="center">${s}</td>
      <td>${acak.join(", ")}</td>
    </tr>`;
  });

  table += "</table>";
  document.getElementById("tableContainer").innerHTML = table;
  document.getElementById("totalInfo").innerHTML =
    `<strong>Derajat Keyakinan:</strong> ${keyakinan} &nbsp;&nbsp; | 
     <strong>Total Populasi:</strong> ${totalPopulasi} &nbsp;&nbsp; | 
     <strong>Total Sampel:</strong> ${totalSampel}`;

  finalData = rows;
}

function downloadExcel() {
  if (finalData.length === 0) {
    alert("Silakan generate data terlebih dahulu.");
    return;
  }
  const ws = XLSX.utils.json_to_sheet(finalData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Data Sampel");
  XLSX.writeFile(wb, "data_sampel_global_unik.xlsx");
}
</script>
</body>
</html>
